# Crypto SQLite Image Cache

> **Deterministic candlestick chart image generation from crypto market data**

A Python tool that renders PNG candlestick charts from OHLCV data stored in SQLite databases. Designed to work with [crypto-sqlite-pipeline](https://github.com/danmcmyler/crypto-sqlite-pipeline) for creating deterministic image datasets for machine learning and backtesting.

## Features

- **Deterministic Rendering**: Identical inputs produce identical images 
- **Idempotent Operations**: Re-runs only generate missing or corrupted images
- **Verifiable Integrity**: SHA256 hashing and gap detection for data quality
- **Organized Storage**: Directory structure with SQLite index for lookups
- **Configurable Visuals**: Chart styles, sizes, and time windows can be adjusted
- **Multiple Modes**: Render new images, verify existing ones, or repair corrupted data

## How It Works

This project complements [crypto-sqlite-pipeline](https://github.com/danmcmyler/crypto-sqlite-pipeline) by consuming the normalized OHLCV data and generating visual representations:

```
crypto-sqlite-pipeline → market.sqlite → crypto-sqlite-image-cache → PNG images
```

1. **crypto-sqlite-pipeline** fetches and normalizes crypto data into `market.sqlite`
2. **crypto-sqlite-image-cache** reads from `market.sqlite` and renders candlestick charts
3. Generated images are stored with deterministic filenames and tracked in a separate index database

## Quick Start

### Prerequisites

1. **Market Data**: You need a `market.sqlite` database generated by [crypto-sqlite-pipeline](https://github.com/danmcmyler/crypto-sqlite-pipeline)
2. **Python Dependencies**: 
   ```bash
   pip install pandas matplotlib mplfinance numpy
   ```

### Basic Usage

```bash
# Render all configured symbols and intervals
python image_cache.py render

# Render specific symbols and date ranges
python image_cache.py render --symbol BTCUSDT --start 2023-01-01 --end 2024-01-01

# Verify image integrity
python image_cache.py verify

# Repair corrupted or missing images
python image_cache.py repair
```

## Configuration

Edit the configuration section in `image_cache.py`:

```python
# SOURCE: your market data database (read-only)
# This should point to the market.sqlite file generated by crypto-sqlite-pipeline
MARKET_DB_PATH = "../crypto-sqlite-pipeline/market.sqlite"

# TARGET: where to store generated images and index
IMAGE_INDEX_DB = "./image_cache.sqlite"
IMAGE_ROOT_DIR = "./image-cache"

# What to generate
PAIRS = ["BTCUSDT", "ETHUSDT", "DOGEUSDT", ...]
INTERVALS = ["15m", "30m", "1h", "4h", "12h", "1d", "1w"]

# Visual settings
IMG_SIZE_PX = 1280      # Square images
WINDOW_LEN = 150        # Candles per chart
STYLE_NAME = "mike"     # mplfinance style
```

## Output Structure

Generated images are organized in a directory structure:

```
image-cache/
├── BTCUSDT/
│   ├── 15m/
│   │   ├── 2023/
│   │   │   ├── 01/
│   │   │   │   ├── BTCUSDT_15m_2023-01-01T00-00-00_px1280_w150_v1.png
│   │   │   │   ├── BTCUSDT_15m_2023-01-01T00-15-00_px1280_w150_v1.png
│   │   │   │   └── ...
│   │   │   └── 02/
│   │   └── 2024/
│   └── 1h/
└── ETHUSDT/
    └── ...
```

Each filename contains:
- Symbol and interval
- End timestamp of the chart window  
- Image size and window length
- Style version (for cache invalidation)

## Command Line Options

```bash
python image_cache.py <mode> [options]

Modes:
  render    Generate new images (skip existing)
  verify    Check image integrity and detect gaps
  repair    Fix corrupted/missing images

Options:
  --symbol SYMBOL     Filter to specific symbol(s) (repeatable)
  --interval INTERVAL Filter to specific interval(s) (repeatable) 
  --start YYYY-MM-DD  Start date (inclusive, default: 2019-01-01)
  --end YYYY-MM-DD    End date (exclusive, default: 2025-08-01)
```

## Examples

```bash
# Generate charts for Bitcoin only, last 2 years
python image_cache.py render --symbol BTCUSDT --start 2022-01-01

# Verify all daily and weekly charts
python image_cache.py verify --interval 1d --interval 1w

# Repair Ethereum charts for specific time range
python image_cache.py repair --symbol ETHUSDT --start 2023-06-01 --end 2023-07-01
```

## Integration with crypto-sqlite-pipeline

### Setup Workflow

1. **Clone and setup crypto-sqlite-pipeline**:
   ```bash
   git clone https://github.com/danmcmyler/crypto-sqlite-pipeline.git
   cd crypto-sqlite-pipeline
   # Follow setup instructions to generate market.sqlite
   ```

2. **Clone this project as a sibling directory**:
   ```bash
   cd ..
   git clone https://github.com/yourusername/crypto-sqlite-image-cache.git
   cd crypto-sqlite-image-cache
   ```

3. **Verify the database path** in `image_cache.py`:
   ```python
   MARKET_DB_PATH = "../crypto-sqlite-pipeline/market.sqlite"
   ```

4. **Generate images**:
   ```bash
   python image_cache.py render
   ```

### Data Flow

The image cache reads directly from the normalized schema created by crypto-sqlite-pipeline:

```sql
-- Query used to load candlestick data
SELECT c.open_time, c.open, c.high, c.low, c.close, c.volume
FROM candles c
JOIN series s ON s.id = c.series_id  
JOIN symbols sy ON sy.id = s.symbol_id
JOIN intervals it ON it.id = s.interval_id
WHERE sy.symbol = ? AND it.code = ? AND c.open_time <= ?
ORDER BY c.open_time DESC LIMIT ?
```

## Design Principles

### Deterministic Output
- **Fixed styling**: Locked mplfinance style ensures visual consistency
- **Stable sizing**: Exact pixel dimensions prevent layout variations  
- **Reproducible filenames**: Based on content timestamps, not generation time
- **Version tracking**: Style version bumping invalidates outdated images

### Data Integrity
- **Read-only source**: Market database opened in immutable mode
- **SHA256 verification**: Optional deep integrity checking
- **Gap detection**: Identifies missing time periods in source data
- **Atomic operations**: Individual image generation is transaction-safe

### Operational Safety
- **Idempotent rendering**: Re-running only processes missing/corrupted images
- **Conservative parallelism**: Single-process execution prevents race conditions
- **Logging**: Detailed progress and performance metrics
- **Graceful failure**: Missing source data marked as "missing", not skipped silently

## Performance Considerations

- **Single-process execution**: Prioritizes determinism over speed
- **Monthly sharding**: Reduces memory usage for large time ranges
- **SQLite optimization**: Configured for read-heavy workloads
- **Incremental updates**: Only generates new images as data grows

## File Formats

### Image Files
- **Format**: PNG (lossless compression)
- **Dimensions**: Square images (default 1280x1280px)
- **Content**: 150-candle windows with configurable styling

### Index Database
Tracks all generated images in `image_cache.sqlite`:

```sql
CREATE TABLE images (
    symbol TEXT NOT NULL,
    interval TEXT NOT NULL, 
    end_open_time_ms INTEGER NOT NULL,
    img_size_px INTEGER NOT NULL,
    window_len INTEGER NOT NULL,
    style_version INTEGER NOT NULL,
    file_path TEXT NOT NULL,
    sha256 TEXT,
    width_px INTEGER NOT NULL,
    height_px INTEGER NOT NULL,
    created_utc TEXT NOT NULL,
    status TEXT NOT NULL CHECK(status IN ('ok','missing','corrupt','stale'))
);
```

## Contributing

This project follows the same principles as crypto-sqlite-pipeline:

1. **Accuracy first**: Correctness over performance
2. **Deterministic behavior**: Reproducible outputs across environments  
3. **Clear documentation**: Self-documenting code with comprehensive comments
4. **Conservative dependencies**: Minimal external requirements

## License

MIT License - see LICENSE file for details.

## Related Projects

- **[crypto-sqlite-pipeline](https://github.com/danmcmyler/crypto-sqlite-pipeline)**: Data collection and normalization (required dependency)
- **Your ML/backtesting projects**: Use the generated images for model training or analysis